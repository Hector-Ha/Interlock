generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  passwordHash String
  firstName String
  lastName  String
  address   String   // JSON string
  identityDocumentId String?
  dateOfBirth String?
  country    String  @default("US")
  
  banks        Bank[]
  transfers    Transfer[]
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bank {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  institutionId   String
  institutionName String
  accessToken     String   // Encrypted later
  itemId          String
  type            String   // checking, savings
  mask            String   // last 4 digits
  transactions    Transaction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, institutionId])
}

model Transfer {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  amount          Decimal
  sourceId        String   // Plaid Account ID
  destinationId   String   // Dwolla destination
  status          String   // PENDING, COMPLETED, FAILED
  dwollaTransferId String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id              String   @id // Plaid transaction_id
  bankId          Int
  bank            Bank     @relation(fields: [bankId], references: [id])
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  name            String
  amount          Decimal
  date            String   // YYYY-MM-DD from Plaid
  paymentChannel  String   // online, in_store, etc.
  type            String   // transaction_type from Plaid
  accountId       String   // Plaid account_id

  createdAt       DateTime @default(now())
}
