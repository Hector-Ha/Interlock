generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String
  firstName         String
  lastName          String
  address           String
  identityDocumentId String
  dateOfBirth       String
  
  country           String
  dwollaCustomerId  String?
  dwollaCustomerUrl String?

  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // P2P Discovery (Phase 4.5)
  phoneNumber     String?   @unique
  phoneVerified   Boolean   @default(false)

  // P2P Transaction Relations (Phase 4.5)
  sentTransactions      Transaction[] @relation("SentTransactions")
  receivedTransactions  Transaction[] @relation("ReceivedTransactions")

  banks             Bank[]
  sessions          Session[]
  auditLogs         AuditLog[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Bank {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plaidItemId       String   @unique
  plaidAccessToken  String

  dwollaFundingUrl  String?
  institutionId     String
  institutionName   String

  @@unique([userId, institutionId])
  @@index([userId, status])

  transactionsCursor String?  // For Plaid sync pagination

  status            BankStatus @default(ACTIVE)
  transactions      Transaction[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Transaction {
  id                String   @id @default(uuid())
  bankId            String
  bank              Bank     @relation(fields: [bankId], references: [id], onDelete: Cascade)

  plaidTransactionId String? @unique  // Link to Plaid transaction
  amount            Decimal
  name              String
  merchantName      String?           // Merchant name from Plaid
  date              DateTime
  
  status            TxStatus @default(PENDING)
  pending           Boolean @default(false)
  channel           String   
  category          String?
  type              TxType   @default(DEBIT)

  destinationBankId String?  // For transfer tracking

  dwollaTransferId  String?  @unique

  // P2P Fields (Phase 4.5)
  senderId      String?
  recipientId   String?
  sender        User?   @relation("SentTransactions", fields: [senderId], references: [id])
  recipient     User?   @relation("ReceivedTransactions", fields: [recipientId], references: [id])
  note          String?  // Optional note for P2P transfers

  @@index([bankId, date])
  @@index([status])
  @@index([senderId])
  @@index([recipientId])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum BankStatus {
  ACTIVE
  LOGIN_REQUIRED
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
  RETURNED
}

enum TxType {
  DEBIT           // Regular bank transaction (outflow)
  CREDIT          // Regular bank transaction (inflow)
  INTERNAL        // Same user, different accounts
  P2P_SENT        // Sent to another user
  P2P_RECEIVED    // Received from another user
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([expiresAt])
}

model WebhookEvent {
  id        String   @id @default(uuid())
  eventId   String   @unique // The unique ID from the provider (e.g. Dwolla event ID)
  provider  String   // "dwolla", "plaid", etc.
  eventType String
  payload   Json?
  
  processedAt DateTime @default(now())

  @@index([eventId, provider])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String
  resource  String
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
}
