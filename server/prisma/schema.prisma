generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String
  firstName         String
  lastName          String
  address           String
  identityDocumentId String
  dateOfBirth       String
  
  country           String
  dwollaCustomerId  String?
  dwollaCustomerUrl String?

  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  banks             Bank[]
  sessions          Session[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Bank {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  plaidItemId       String   @unique
  plaidAccessToken  String

  dwollaFundingUrl  String?
  institutionId     String
  institutionName   String

  @@unique([userId, institutionId])
  @@index([userId, status])

  status            BankStatus @default(ACTIVE)
  transactions      Transaction[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Transaction {
  id                String   @id @default(uuid())
  bankId            String
  bank              Bank     @relation(fields: [bankId], references: [id], onDelete: Cascade)

  amount            Decimal
  name              String
  date              DateTime
  
  status            TxStatus @default(PENDING)
  channel           String   
  category          String?

  dwollaTransferId  String?  @unique

  @@index([bankId, date])
  @@index([status])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum BankStatus {
  ACTIVE
  LOGIN_REQUIRED
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
  RETURNED
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  
  createdAt    DateTime @default(now())

  @@index([userId])

  @@index([expiresAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  details   Json?
  ipAddress String?
  
  createdAt DateTime @default(now())
}
